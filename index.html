<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
// ... (existing code) ...
    <title>Mapa Político de Guerrero - Descubre tu Perfil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
    <!-- Survey Section (Initially Hidden) -->
    <section id="encuesta-container" class="fixed inset-0 bg-gray-800 z-50 p-4 overflow-y-auto hidden opacity-0">
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
            const intervalId = preguntaActualDiv.dataset.intervalId;
// ... (existing code) ...
                clearInterval(intervalId);
            }

// ... (existing code) ...
// ... (existing code) ...
            setTimeout(() => resultsContainer.style.opacity = 1, 510);
            
// ... (existing code) ...
// ... (existing code) ...
            } else { // Centrista o Independiente
                shareableImageUrl = 'https://i.ibb.co/35XZc4P9/Centrista.png';
            }
            
            // Esta es la vista previa de la infografía. Usamos tus imágenes.
            // AÑADIMOS un id="share-image-preview" al div principal
            const shareableImageHTML = `
                <div id="share-image-preview" class="bg-cover bg-center p-6 rounded-lg text-white font-inter w-full max-w-md mx-auto shadow-2xl" style="background-image: url('${shareableImageUrl}');">
                     <!-- El contenido de la infografía generada por el backend iría aquí -->
// ... (existing code) ...
// ... (existing code) ...
                     <p class="text-center text-sm text-gray-200 mb-4" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.7);">Guerrero 2025</p>
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
                </div>
            `;

            const resultsHTML = `
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
                        <h2 class="text-2xl font-bold mb-4 text-center">¡Comparte tu resultado!</h2>
                        <p class="text-center text-gray-400 mb-4">Usa los botones para compartir o descargar tu infografía personalizada.</p>
                        ${shareableImageHTML}
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-8">
                            <button class="bg-green-500 hover:bg-green-600 p-3 rounded-lg font-bold">Compartir en WhatsApp</button>
                            <button class="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg font-bold">Compartir en Facebook</button>
                            <button class="bg-blue-400 hover:bg-blue-500 p-3 rounded-lg font-bold">Compartir en Twitter</button>
                            <!-- AÑADIMOS un id="download-btn" al botón -->
                            <button id="download-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 p-3 rounded-lg font-bold">Descargar Imagen</button>
                        </div>
                    </div>
                </div>
            `;
            resultsContent.innerHTML = resultsHTML;

            // AÑADIMOS el 'click listener' para el botón de descarga
            document.getElementById('download-btn').onclick = downloadShareImage;
        }

        // --- LÓGICA DE CÁLCULO (YA NO SE USA EN EL FRONTEND) ---
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
            };
        }

// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
        }
        // ----------------------------------------

        // AÑADIMOS la nueva función para descargar la imagen
        function downloadShareImage() {
            const downloadButton = document.getElementById('download-btn');
            downloadButton.innerText = "Generando...";
            downloadButton.disabled = true;

            const elementToCapture = document.getElementById('share-image-preview');
            
            html2canvas(elementToCapture, {
                useCORS: true, // Importante para que cargue la imagen de fondo
                allowTaint: true,
                scale: 2 // Genera la imagen al doble de resolución
            }).then(canvas => {
                // Crear un link temporal
                const link = document.createElement('a');
                link.download = 'mi-perfil-politico-guerrero.png';
                link.href = canvas.toDataURL('image/png');
                
                // Simular clic para descargar
                link.click();

                // Restaurar botón
                downloadButton.innerText = "Descargar Imagen";
                downloadButton.disabled = false;
            }).catch(err => {
                console.error("Error al generar imagen con html2canvas:", err);
                downloadButton.innerText = "Error al descargar";
                // No deshabilitar para que pueda reintentar
                setTimeout(() => {
                    downloadButton.innerText = "Descargar Imagen";
                }, 2000);
            });
        }

        function handleAnswer(answerData) { userAnswers.push({pregunta_id: allQuestions[currentQuestionIndex].id, respuesta: answerData}); nextQuestion(); }
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code) ...
// ... (existing code)
    </script>
</body>
</html>

